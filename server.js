var express = require('express');
var http = require('http');
var path = require('path');
var debug = require('debug')('server');

var server = express();
var router = express.Router();
var port = process.env.PORT || 3333;
var __DEBUG__ = process.env.DEBUG === 'server' ? true : false;

var __mydebug__ = process.env.mydebug === 'true' ? process.env.mydebug : 'Not defined！'
console.log('__mydebug__: ' + __mydebug__);

/**
 * process.env.DEBUG 只有在引入webpack.config 才会赋值
 * 而且必须在server.js 里 var compiler = webpack(config)
 * 并且在 server.use(require('webpack-hot-middleware')(compiler)) 热替换
 * 所以 这种架构是基于 express 下驱动 webpack的
 * 并不适合 我的gulp+webpack
 */

server.use(express.static(__dirname + '/assets/dist'))

/* GET home page. */
router.param('name', function(req, res, next, name) {
    // 对name进行验证或其他处理……
    console.dir(name, {colors: true});
    req.name = name;
    next();
});
router.get('/:name', function(req, res, next) {
    var data = {
        counter: {
            count: 0
        },
        postsBySubreddit: {},
        selectedSubreddit: "reactjs",
        todos: [
            {
                completed: false,
                text: req.name
            }
        ],
        visibilityFilter: "SHOW_ALL"

    }
    console.dir(data, {colors: true});
    res.json(data);
});

server.use('/', router);

server.get('*', function(request, response) {
    response.sendFile(path.resolve(__dirname, 'assets/dist/webpack_coc/', 'organization.html'))
})

//直接执行的时候（node module.js），require.main属性指向模块本身。
// if (require.main === module) {
//     var server = http.createServer(app);
//     server.listen(port, '0.0.0.0', function() {
//         var address = server.address(); //获取服务端信息
//         debug('Listening on: %j', address);
//         debug(' -> that probably means: http://localhost:%d', address.port);
//         debug('__DEBUG__：: %j', __DEBUG__);
//         // console.log('__DEBUG__：' + __DEBUG__);
//         // console.log('Listening on: %j', address);
//         // console.log(' -> that probably means: http://localhost:%d', address.port);
//     });
// }

// 错误处理
server.on('clientError', (err, socket) => {
  socket.end('HTTP/1.1 400 Bad Request\r\n\r\n');
});

module.exports = {server: server, port: port, debug: __DEBUG__};
